// Educake Automation Script - Fixed Version
// This version loads answers data from the embedded object

let answers = {};
let unhashed = {};
let jQueryLoaded = false;
let cryptoLoaded = false;

// Override setTimeout to speed up delays
const _setTimeout = setTimeout;
setTimeout = function (a, b, ...c) {
    b = b <= 3000 ? 1 : b;
    _setTimeout(a, b, ...c);
};

function getQuestionText() {
    const questionText = $('.question-text').text().trim();
    const options = $('.option').map((i, el) => $(el).find('.option-text').text().trim()).get().sort().join(',');
    const images = $('.question-images img').map((i, el) => $(el).attr('src')).get().join(',');
    return `${questionText}options=${options}img=${images}`;
}

function getQuestionIdentifier() {
    const questionText = getQuestionText();
    return CryptoJS.MD5(questionText).toString();
}

function typeAnswer(answer) {
    const input = $('input[type="text"]').first();
    if (input.length) {
        input.val(answer).trigger('input').trigger('change');
    }
}

function clickOption(index) {
    $('.option').eq(index).click();
}

function setCorrectAnswer() {
    const questionId = getQuestionIdentifier();
    const correctAnswers = answers[questionId];
    
    if (!correctAnswers) {
        console.log('No answer found for this question');
        return false;
    }
    
    const questionType = $('.question-type').attr('data-type');
    
    if (questionType === 'text-input') {
        typeAnswer(correctAnswers[0]);
    } else {
        const options = $('.option .option-text').map((i, el) => $(el).text().trim()).get();
        const answerIndex = options.findIndex(opt => correctAnswers.includes(opt));
        if (answerIndex !== -1) {
            clickOption(answerIndex);
        }
    }
    
    return true;
}

function setAnswer(answer) {
    const questionType = $('.question-type').attr('data-type');
    
    if (questionType === 'text-input') {
        typeAnswer(answer);
    } else {
        const options = $('.option .option-text').map((i, el) => $(el).text().trim()).get();
        const answerIndex = options.findIndex(opt => opt === answer);
        if (answerIndex !== -1) {
            clickOption(answerIndex);
        }
    }
}

function doQuestion() {
    if (setCorrectAnswer()) {
        setTimeout(() => {
            $('.submit-button').click();
        }, 100);
    }
}

function setAnyAnswer() {
    const questionType = $('.question-type').attr('data-type');
    
    if (questionType === 'text-input') {
        typeAnswer('1');
    } else {
        clickOption(0);
    }
}

function play() {
    $('body').append('<iframe width="0" height="0" src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1" frameborder="0" allow="autoplay"></iframe>');
}

function generateButtons() {
    if ($('.educake-hack-buttons').length > 0) return;
    
    const buttonContainer = $('<div class="educake-hack-buttons"></div>').css({
        position: 'fixed',
        top: '10px',
        right: '10px',
        zIndex: 9999,
        display: 'flex',
        gap: '10px'
    });
    
    const hintButton = $('<button>Hint</button>').css({
        padding: '10px 20px',
        backgroundColor: '#4CAF50',
        color: 'white',
        border: 'none',
        borderRadius: '5px',
        cursor: 'pointer'
    }).click(() => setCorrectAnswer());
    
    const autoButton = $('<button>Azgore</button>').css({
        padding: '10px 20px',
        backgroundColor: '#2196F3',
        color: 'white',
        border: 'none',
        borderRadius: '5px',
        cursor: 'pointer'
    }).click(() => doQuestion());
    
    buttonContainer.append(hintButton, autoButton);
    $('body').append(buttonContainer);
}

function importFromURL(url, finished) {
    const script = document.createElement('script');
    script.src = url;
    script.onload = finished;
    document.head.appendChild(script);
}

// Load answers data from GitHub
async function loadAnswersData() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/Sploopo/hax/main/answers.json');
        const data = await response.json();
        answers = data.hashed || {};
        unhashed = data.unhashed || {};
        console.log('Answers loaded successfully:', Object.keys(answers).length, 'questions');
        return true;
    } catch (error) {
        console.error('Failed to load answers:', error);
        return false;
    }
}

function checkAllLoaded() {
    if (jQueryLoaded && cryptoLoaded) {
        console.log('All dependencies loaded, loading answers...');
        loadAnswersData().then(() => {
            console.log('Generating buttons...');
            generateButtons();
        });
    }
}

// Load jQuery
importFromURL(
    'https://code.jquery.com/jquery-3.7.1.min.js',
    () => {
        console.log('jQuery loaded');
        jQueryLoaded = true;
        checkAllLoaded();
    }
);

// Load CryptoJS
importFromURL(
    'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js',
    () => {
        console.log('CryptoJS loaded');
        cryptoLoaded = true;
        checkAllLoaded();
    }
);

console.log('Educake script initializing...');
